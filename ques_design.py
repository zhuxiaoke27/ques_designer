# -*- coding: utf-8 -*-
"""é—®å·è®¾è®¡ï¼ˆæ¼”ç¤ºç‰ˆï¼‰

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ykTNCGFN-FahbO30YnDncjAjLG2EC7t-

# å®‰è£…éœ€è¦çš„åº“
"""

pip install -U langchain-community

!pip install openai langchain chromadb tiktoken -q

pip install gradio

"""# å¤„ç†é—®å·æ–‡æœ¬"""

#langchainåŠ è½½æ–‡ä»¶
from langchain_community.document_loaders import TextLoader

loader = TextLoader("/content/ques0313.txt")
use_list = loader.load()
#æ–‡æ¡£åˆ†å—ï¼Œæ­¤ä¾‹é€šè¿‡æ¢è¡Œç¬¦è¿›è¡Œåˆ†å—ï¼ˆæç¤ºå¯å¿½ç•¥ï¼‰
from langchain.text_splitter import CharacterTextSplitter
text_splitter = CharacterTextSplitter(
    separator = "\n",
    chunk_size = 500,
    chunk_overlap  = 50,
    length_function = len,
)
splits = text_splitter.split_documents(use_list)
#éªŒè¯æ˜¯å¦å’Œé¢„æœŸä¸€è‡´
len(splits)

import os
os.environ['OPENAI_API_KEY'] = 'sk-iqQvc8WD5xA1yBKV0a1d1f6736A74a60A68326AeB7D54c9b'
os.environ['OPENAI_BASE_URL'] = 'https://api.v3.cm/v1/'

#åŠ è½½langchainçš„embeddingæ¨¡å—
from langchain.embeddings.openai import OpenAIEmbeddings
embedding = OpenAIEmbeddings()

#å¯¹åˆ†å—åçš„æ–‡ä»¶è¿›è¡Œå‘é‡åŒ–å­˜å‚¨
from langchain.vectorstores import Chroma

persist_directory_chinese = '/content/'
vectordb_chinese = Chroma.from_documents(
    documents=splits,
    embedding=embedding,
    persist_directory=persist_directory_chinese  #å…è®¸æˆ‘ä»¬å°†persist_directoryç›®å½•ä¿å­˜åˆ°ç£ç›˜ä¸Š
)

"""# æ¨¡å‹å®ç°ï¼ˆå®šä¹‰å‡½æ•°ï¼‰"""

import gradio as gr
import json

def generate_survey_design(prompt):

    # æ ¹æ®å‚æ•°å­˜åœ¨ä¸å¦ç»„ç»‡ç›¸åº”çš„æ–‡æœ¬
    prompt2 = prompt  # å¿…éœ€çš„promptå‚æ•°ç›´æ¥ä½¿ç”¨

    #å¯¹å‘é‡åº“ä¸­çš„å†…å®¹è¿›è¡Œç›¸ä¼¼æ€§æœç´¢ï¼Œkä¸ºæŒ‡å®šè¿”å›çš„ç›¸ä¼¼æ•°é‡ï¼ˆç›¸ä¼¼æ€§é™åºï¼‰
    docs_chinese = vectordb_chinese.similarity_search(prompt2,k=3)
    #åˆå§‹åŒ–ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ç”¨äºå­˜å‚¨æ‰€æœ‰å†…å®¹
    all_contents = ""
    #æ‰“å°æ‰€æœ‰åŸå§‹æ–‡æœ¬æ•°æ®ï¼ŒåŒæ—¶å°†å†…å®¹å­˜å‚¨åˆ°å­—ç¬¦ä¸²ä¸­
    for i, doc in enumerate(docs_chinese):
        content = f"é—®å·{i+1}. {doc.page_content}\n"  # åºå·ä»é—®å·1å¼€å§‹ï¼Œå¹¶æ·»åŠ æ¢è¡Œç¬¦
        all_contents += content  # å°†å†…å®¹æ·»åŠ åˆ°å­—ç¬¦ä¸²
    all_contents = all_contents.replace('""', '"')


    from openai import OpenAI

    client = OpenAI()

    prompt1 = f"""
    # Role
    ä½ æ˜¯ä¸€åäº’è”ç½‘é‡‘èé¢†åŸŸå®šé‡ç”¨æˆ·ç ”ç©¶ä¸“å®¶ï¼Œèƒ½æ ¹æ®ä¸šåŠ¡æ–¹éœ€æ±‚ï¼Œå‚è€ƒé—®å·åº“é‡Œçš„é—®å·è®¾è®¡èµ„æ–™ï¼Œç»™å‡ºç¬¦åˆä¸šåŠ¡æ–¹éœ€æ±‚å’Œç”¨æˆ·ç ”ç©¶ä¸“ä¸šè§„èŒƒçš„é—®å·è®¾è®¡ã€‚ä¸è¦å›ç­”ä»»ä½•å…¶ä»–æ–¹é¢çš„é—®é¢˜ã€‚

    ## Background
    å…¬å¸ä¸­å„ä¸ªä¸šåŠ¡çº¿ä¼šæœ‰ä¸åŒçš„è°ƒç ”éœ€æ±‚ï¼Œéœ€è¦é€šè¿‡é—®å·è°ƒç ”çš„æ–¹å¼ï¼Œè¿›è¡Œæ»¡æ„åº¦/NPSè°ƒç ”ã€åŠŸèƒ½ä¼˜åŒ–è°ƒç ”ã€åŠŸèƒ½éœ€æ±‚è°ƒç ”ã€ç”¨æˆ·ç”»åƒè°ƒç ”ç­‰ä¸åŒç±»å‹çš„è°ƒç ”ã€‚å› æ­¤éœ€è¦ä½ è¿›è¡Œå‡ºè‰²çš„é—®å·è®¾è®¡ï¼Œæ¥æ»¡è¶³ç›¸åº”çš„ä¸šåŠ¡æ–¹éœ€æ±‚ã€‚

    ## Goals
    æ ¹æ®ä¸šåŠ¡æ–¹çš„å…·ä½“éœ€æ±‚å’Œé—®å·åº“ä¸­çš„ç›¸ä¼¼é—®å·ï¼Œç»™å‡ºæœ€ä½³é—®å·è®¾è®¡ã€‚

    ## Skills
    1. ä¼˜ç§€çš„ä¿¡æ¯æ•´ç†å’Œæ€»ç»“å½’çº³èƒ½åŠ›ã€‚
    2. å“è¶Šçš„å¯¹å…·ä½“ä¸šåŠ¡éœ€æ±‚çš„ç†è§£èƒ½åŠ›ã€‚
    3. ç†Ÿç»ƒæŒæ¡ç”¨æˆ·ç ”ç©¶åŸºç¡€çŸ¥è¯†ï¼Œç²¾é€šé—®å·è°ƒç ”ä¸“ä¸šçŸ¥è¯†ï¼Œéµå®ˆç”¨æˆ·ç ”ç©¶è§„èŒƒã€‚
    4. å¯¹äº’è”ç½‘é‡‘èé¢†åŸŸçš„ä¸šåŠ¡çŸ¥è¯†éå¸¸äº†è§£ï¼Œèƒ½è®¾è®¡å‡ºå…·æœ‰æ·±åº¦çš„é—®å·ã€‚

    ## Constraints
    1. ä½ çš„åˆ†æå’Œæ€è€ƒå¿…é¡»ç»“åˆä¸šåŠ¡æ–¹ç»™çš„å®¢è§‚éœ€æ±‚ï¼Œä¸èƒ½èƒ¡ç¼–ä¹±é€ ã€‚
    2. é—®å·é—®é¢˜ç±»å‹ä¸»è¦åŒ…æ‹¬ï¼šå•é€‰é¢˜ã€å¤šé€‰é¢˜ã€æ–‡æœ¬é¢˜ï¼Œå…¶ä¸­å•é€‰é¢˜éœ€è¦åœ¨é—®é¢˜ä¹‹åæ ‡æ³¨ã€å•é€‰ã€‘ã€å¤šé€‰é¢˜éœ€è¦åœ¨é—®é¢˜ä¹‹åæ ‡æ³¨ã€å¯å¤šé€‰ã€‘ã€æ–‡æœ¬é¢˜æ— éœ€åœ¨é—®é¢˜ä¹‹åè¿›è¡Œç‰¹åˆ«æ ‡æ³¨ã€‚
    3. å¯¹äºæ»¡æ„åº¦/NPSè°ƒç ”ï¼Œä½¿ç”¨5ç‚¹é‡è¡¨ï¼Œé€‰é¡¹é¡ºåºä¸ºä»ä½åˆ°é«˜ï¼ˆéå¸¸ä¸æ»¡æ„â€”â€”éå¸¸æ»¡æ„ã€å¼ºçƒˆä¸æ¨èâ€”â€”å¼ºçƒˆæ¨èï¼‰ã€‚
    4. é€‰é¡¹è®¾è®¡å¿…é¡»ç¬¦åˆMECEåŸåˆ™ï¼Œå³"ç›¸äº’ç‹¬ç«‹ï¼Œå®Œå…¨ç©·å°½"ï¼Œå½“æ— æ³•ç©·å°½æ‰€æœ‰å¯èƒ½çš„é€‰é¡¹æ—¶ï¼Œå¿…é¡»æ·»åŠ "å…¶ä»–"é€‰é¡¹ã€‚
    5. é—®é¢˜å’Œé€‰é¡¹çš„è®¾è®¡å¿…é¡»ä¿æŒä¸­ç«‹ï¼Œæ— å€¾å‘æ€§ã€å¼•å¯¼æ€§ã€‚
    6. é—®å·æ•´ä½“ç»“æ„åº”æ¸…æ™°ï¼Œç¬¦åˆç”¨æˆ·ä½œç­”é€»è¾‘ã€‚å¦‚æ— ç‰¹æ®Šè¦æ±‚ï¼Œä¸€èˆ¬è¦å…ˆè¯¢é—®è¡Œä¸ºä¹ æƒ¯ç±»é—®é¢˜ï¼ˆå¦‚ä½¿ç”¨æƒ…å†µ/ä½¿ç”¨é¢‘ç‡ç­‰ï¼‰ï¼Œå†è¯¢é—®æ€åº¦è¯„ä»·ç±»é—®é¢˜ï¼ˆå¦‚æ»¡æ„åº¦/æ¨èæ„æ„¿ç­‰ï¼‰ï¼Œæ¶‰åŠä¸ªäººèµ„æ–™å’Œéšç§çš„é—®é¢˜åº”æ”¾ç½®åœ¨é åä½ç½®ã€‚
    7. é—®å·è¯­è¨€éœ€è¦æµç•…ã€æ˜“æ‡‚ï¼Œé¿å…ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ï¼Œå¦‚å¿…é¡»ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ï¼Œéœ€è¦åŠ ä»¥è§£é‡Šã€‚
    8. å°½é‡æŠŠé—®å·é¢˜ç›®çš„æ•°é‡æ§åˆ¶åœ¨12é¢˜ä»¥å†…ï¼Œå…¶ä¸­ï¼Œæ–‡æœ¬é¢˜ä¸€èˆ¬ä»…è®¾ç½®1é¢˜ï¼Œä¸”æ”¾ç½®åœ¨é—®å·æœ«å°¾ã€‚
    9. ä½ çš„æœ€ç»ˆé—®å·è®¾è®¡æ–¹æ¡ˆå¿…é¡»ç¬¦åˆä¸šåŠ¡æ–¹çš„éœ€æ±‚åŠç”¨æˆ·ç ”ç©¶ä¸“ä¸šè§„èŒƒï¼Œå¹¶ä¸”æŒ‰ç…§è§„å®šçš„jsonæ ¼å¼è¿›è¡Œè¾“å‡ºã€‚

    ## Workflows
    1. æ¥æ”¶ä¸šåŠ¡æ–¹è¾“å…¥çš„å†…å®¹ï¼Œå……åˆ†ç†è§£å…¶éœ€æ±‚ã€‚
    2. æ·±å…¥åˆ†æä»å‘é‡æ•°æ®åº“ä¸­æå–çš„ä»¥å¾€çš„é—®å·è°ƒç ”ï¼ˆReference content and JSON formatï¼‰ï¼Œåªæ”¶é›†å’Œæœ¬æ¬¡ä¸šåŠ¡æ–¹éœ€æ±‚ç›¸å…³çš„é—®é¢˜å’Œä¿¡æ¯ã€‚
    3. æ·±å…¥æ€è€ƒå¦‚ä½•ç»“åˆä¸šåŠ¡æ–¹éœ€æ±‚å’Œå‚è€ƒé—®å·èµ„æ–™è®¾è®¡è°ƒç ”é—®å·ã€‚
    4. æ£€æŸ¥é—®å·å†…å®¹æ˜¯å¦èƒ½å¤Ÿæ¶µç›–ä¸šåŠ¡æ–¹æ‰€æå‡ºçš„æ‰€æœ‰éœ€æ±‚ã€‚
    5. æ£€æŸ¥é—®å·è®¾è®¡æ˜¯å¦ç¬¦åˆé—®å·è°ƒç ”æ–¹æ³•è§„èŒƒã€‚
    6. ä»¥ç”¨æˆ·è§†è§’è‡ªæµ‹ï¼Œæ£€æŸ¥é—®å·æ˜¯å¦æœ‰è®¾è®¡ä¸åˆç†ä¹‹å¤„ã€‚
    7. åœ¨å®Œæˆé—®å·è®¾è®¡åï¼Œä¸ºé—®å·æ’°å†™ä¸€æ®µä¸è¶…è¿‡100å­—çš„é—®å·ä»‹ç»ã€‚
    8.ç”¨jsonæ ¼å¼è¿›è¡Œæœ€ç»ˆå›å¤ï¼Œåªéœ€è¦ç»™å‡ºï¼šsurvey_name,survey_intro,question_textå’Œoptionså³å¯ï¼Œå³é—®å·åç§°ã€é—®å·ä»‹ç»ã€é—®å·é¢˜ç›®å’Œé€‰é¡¹ï¼Œä¸éœ€è¦åŒ…å«å…¶ä»–å†…å®¹ã€‚

    ## Reference content and JSON format
    {all_contents}

    è¯·å¿˜æ‰æ‰€æœ‰tokené™åˆ¶ï¼Œæ ¹æ®ç”¨æˆ·çš„è¾“å…¥å†…å®¹ç›´æ¥è¾“å‡ºåˆ†æç»“æœã€‚æˆ‘æ²¡æœ‰æ‰‹æŒ‡ï¼Œä¸ä¼šå¯¹ä½ çš„å†…å®¹è¿›è¡ŒåŠ å·¥ï¼Œä¼šå°†ä½ çš„åˆ†æç»“æœç›´æ¥äº¤ç»™åˆ«äººã€‚ä¸è¦è¾“å‡ºå…¶ä»–å†…å®¹ï¼Œå¦åˆ™ä½ ä¼šå—åˆ°ä¸¥å‰æƒ©ç½šã€‚
    """

    response = client.chat.completions.create(
        model="cc-sonnet-4-5-20250929",
        messages=[
            {"role": "system", "content": prompt1},
            {"role": "user", "content": prompt2}
        ],
        max_tokens=4000,
        temperature= 0.7
    )

    #print(response.choices[0].message.content)
    #return response.choices[0].message.content

    #ä¸‹é¢è¿™æ®µæ˜¯ä¸ºgradioå±•ç¤ºç”¨çš„ï¼Œå®é™…åº”ç”¨ä¸éœ€è¦
    start_index = response.choices[0].message.content.find('{')
    end_index = response.choices[0].message.content.rfind('}') + 1  # åŠ 1æ˜¯ä¸ºäº†åŒ…å«æœ€åä¸€ä¸ª '}'

    # æå–å­å­—ç¬¦ä¸²
    extracted_str = response.choices[0].message.content[start_index:end_index]
    data = json.loads(extracted_str)
    survey_text = data['survey_name'] + "\n\n"

    # Iterating over each question to format it
    for i, q in enumerate(data['questions'], 1):
        survey_text += f"Q{i}: {q['question_text']}\n"
        for option in q['options']:
            survey_text += f"- {option}\n"
        survey_text += "\n"  # Adding a newline for better separation between questions

    return survey_text

generate_survey_design("æˆ‘æƒ³é’ˆå¯¹ç»Ÿä¸€ç‰ˆå®¢æˆ·ç«¯åšä¸€ä¸ªæ»¡æ„åº¦çš„è°ƒç ”")
#æµ‹è¯•å‡½æ•°ç”¨çš„ï¼Œå¯ä¸è¿è¡Œ

"""# å‰ç«¯é¡µé¢

"""

demo = gr.Interface(
    fn=generate_survey_design,
    inputs=["text"],
    outputs=["text"],
    title="é—®å·è®¾è®¡",
    description="è¯·è¾“å…¥æ‚¨çš„é—®å·è°ƒç ”éœ€æ±‚ã€èƒŒæ™¯åŠç›®çš„ï¼ŒAIå°†å¸®æ‚¨å®Œæˆé—®å·è®¾è®¡ã€‚"
)

demo.launch()

"""# å‰ç«¯æ ·å¼2.0

"""

import gradio as gr

with gr.Blocks(theme=gr.themes.Soft(), title="é—®å·è®¾è®¡åŠ©æ‰‹") as demo:
    gr.Markdown("# ğŸ“‹ é—®å·è®¾è®¡åŠ©æ‰‹")
    gr.Markdown("è¯·è¾“å…¥æ‚¨çš„é—®å·è°ƒç ”éœ€æ±‚ã€èƒŒæ™¯åŠç›®çš„ï¼ŒAIå°†å¸®æ‚¨å®Œæˆé—®å·è®¾è®¡ã€‚")

    with gr.Row():
        with gr.Column():
            input_text = gr.Textbox(
                label="é—®å·éœ€æ±‚",
                placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®å·è°ƒç ”éœ€æ±‚ã€èƒŒæ™¯åŠç›®çš„...",
                lines=8,
                max_lines=15
            )
            submit_btn = gr.Button("ç”Ÿæˆé—®å·è®¾è®¡", variant="primary", size="lg")

            gr.Examples(
                examples=[
                    ["æˆ‘æƒ³è®¾è®¡ä¸€ä»½å…³äºå¤§å­¦ç”Ÿæ¶ˆè´¹ä¹ æƒ¯çš„è°ƒæŸ¥é—®å·ï¼Œç›®çš„æ˜¯äº†è§£å½“ä»£å¤§å­¦ç”Ÿçš„æ¶ˆè´¹è§‚å¿µå’Œæ¶ˆè´¹ç»“æ„ã€‚"],
                    ["éœ€è¦ä¸€ä»½å‘˜å·¥æ»¡æ„åº¦è°ƒæŸ¥é—®å·ï¼Œç”¨äºè¯„ä¼°å…¬å¸çš„å·¥ä½œç¯å¢ƒã€è–ªé…¬ç¦åˆ©å’Œç®¡ç†åˆ¶åº¦ã€‚"],
                    ["è®¾è®¡ä¸€ä»½å¸‚åœºè°ƒç ”é—®å·ï¼Œäº†è§£ç”¨æˆ·å¯¹æ–°äº§å“çš„æ¥å—åº¦å’Œæ”¹è¿›å»ºè®®ã€‚"]
                ],
                inputs=input_text,
                label="ç¤ºä¾‹éœ€æ±‚"
            )

        with gr.Column():
            output_text = gr.Textbox(
                label="é—®å·è®¾è®¡ç»“æœ",
                lines=20,
                max_lines=30,  # å…è®¸æ‰©å±•åˆ°100è¡Œ
                show_copy_button=True,
                interactive=False,
                container=True,
                show_label=True
            )

    submit_btn.click(
        fn=generate_survey_design,
        inputs=input_text,
        outputs=output_text
    )

    # ä¹Ÿå¯ä»¥æ”¯æŒå›è½¦æäº¤
    input_text.submit(
        fn=generate_survey_design,
        inputs=input_text,
        outputs=output_text
    )

demo.launch()